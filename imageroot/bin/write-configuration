#!/bin/bash

#
# Copyright (C) 2024 Nethesis S.r.l.
# SPDX-License-Identifier: GPL-3.0-or-later
#

# Retrieving environment variables
LDAP_DOMAIN=${LDAP_DOMAIN}
LDAP_PORT=${LDAP_PORT}
LDAP_USER=${LDAP_USER}
LDAP_HOST=${LDAP_HOST}
LDAP_PASS=${LDAP_PASS}
LDAP_SCHEMA=${LDAP_SCHEMA}
LDAP_BASE=${LDAP_BASE}

# Retrieving Dokuwiki configuration variables
DOKUWIKI_FULL_NAME=${DOKUWIKI_FULL_NAME}
DOKUWIKI_PASSWORD=${DOKUWIKI_PASSWORD}
DOKUWIKI_USERNAME=${DOKUWIKI_USERNAME}
DOKUWIKI_WIKI_NAME=${DOKUWIKI_WIKI_NAME}
DOKUWIKI_EMAIL=${DOKUWIKI_EMAIL}

mkdir -vp dokuwiki-config
cat <<EOF > dokuwiki-config/acl.auth.php
# acl.auth.php
# <?php exit()?>
# Don't modify the lines above
#
# Access Control Lists
*               @ALL          0
*               @user         8
EOF
echo "Configuration written to dokuwiki-config/acl.auth.php"

cat <<EOF > dokuwiki-config/local.php
<?php
/**
 * Dokuwiki's Main Configuration File - Local Settings
 */
\$conf['title'] = '${DOKUWIKI_WIKI_NAME}';
\$conf['lang'] = 'en';
\$conf['license'] = '0';
\$conf['useacl'] = 1;
\$conf['superuser'] = '@${DOKUWIKI_USERNAME}';
\$conf['disableactions'] = 'register';
EOF
echo "Configuration written to dokuwiki-config/local.php"

PASS_HASH=$(podman exec dokuwiki htpasswd -nbB ${DOKUWIKI_USERNAME} ${DOKUWIKI_PASSWORD})
cat <<EOF >> dokuwiki-config/users.auth.php
# users.auth.php
# <?php exit()?>
# Don't modify the lines above
#
# Userfile
#
# Format:
# login:passwordhash:Real Name:email:groups,comma,separated

${PASS_HASH}:${DOKUWIKI_FULL_NAME}:${DOKUWIKI_EMAIL}:admin,user
EOF
echo "Configuration written to dokuwiki-config/users.auth.php"

cat <<EOF > dokuwiki-config/local.protected.php
<?php
/**
 * this is file is generated by the dokuwki container automatically
 * do not edit it manually
 */
EOF
# Check the value of $LDAP_DOMAIN
if [[ "$LDAP_DOMAIN" == "" ]]; then
    cat <<EOF >> dokuwiki-config/local.protected.php
\$conf['authtype'] = 'authplain';
EOF

elif [[ "$LDAP_DOMAIN" != "" ]]; then
    if [[ "$LDAP_SCHEMA" == "rfc2307" ]]; then
        cat <<EOF >> dokuwiki-config/local.protected.php
\$conf['authtype'] = 'authldap';
\$conf['plugin'][\$conf['authtype']]['server'] = "ldap://accountprovider:${LDAP_PORT}";
\$conf['plugin'][\$conf['authtype']]['version'] = '3';
\$conf['plugin'][\$conf['authtype']]['usertree'] = "ou=People,${LDAP_BASE}";
\$conf['plugin'][\$conf['authtype']]['grouptree'] = "ou=Groups,${LDAP_BASE}";
\$conf['plugin'][\$conf['authtype']]['userfilter'] = '(|(uid=%{user})(mail=%{user}))';
\$conf['plugin']['authldap']['groupfilter']  = '(memberUid=%{uid})';
\$conf['plugin'][\$conf['authtype']]['groupkey'] = 'cn';
\$conf['plugin']['authldap']['binddn']     = "${LDAP_USER}";
\$conf['plugin']['authldap']['bindpw']     = "${LDAP_PASS}";
\$conf['plugin']['authldap']['starttls']   = 0;
\$conf['plugin']['authldap']['modPass'] = 0;
EOF
    elif [[ "$LDAP_SCHEMA" == "ad" ]]; then
        cat <<EOF >> dokuwiki-config/local.protected.php
\$conf['authtype'] = 'authad';
\$conf['plugin']['authad']['account_suffix']     = '@${LDAP_DOMAIN}';
\$conf['plugin']['authad']['base_dn']            = '${LDAP_BASE}';
\$conf['plugin']['authad']['domain_controllers'] = 'ldap://accountprovider:${LDAP_PORT}'; //multiple can be given
\$conf['plugin']['authad']['use_tls'] = 0;
EOF

    fi
fi
cat <<EOF >> dokuwiki-config/local.protected.php
\$conf['useacl'] = 1;
\$conf['superuser'] = '@admin,@domain admins';
EOF

echo "Configuration written to dokuwiki-config/local.protected.php"

cat <<EOF > dokuwiki-config/plugins.local.php
<?php
/*
 * Local plugin enable/disable settings
 *
 * Auto-generated by install s
 */

\$plugins['authad']    = 1;
\$plugins['authldap']  = 1;
\$plugins['authmysql'] = 0;
\$plugins['authpgsql'] = 0;
EOF
echo "Configuration written to dokuwiki-config/plugins.local.php"
