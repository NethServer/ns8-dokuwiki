#!/bin/bash

#
# Copyright (C) 2024 Nethesis S.r.l.
# SPDX-License-Identifier: GPL-3.0-or-later
#

# Retrieving environment variables
LDAP_DOMAIN=${LDAP_DOMAIN}
LDAP_PORT=${LDAP_PORT}
LDAP_USER=${LDAP_USER}
LDAP_HOST=${LDAP_HOST}
LDAP_PASS=${LDAP_PASS}
LDAP_SCHEMA=${LDAP_SCHEMA}
LDAP_BASE=${LDAP_BASE}

mkdir -vp dokuwiki-config
cat <<EOF > dokuwiki-config/local.protected.php
<?php
/**
 * this is file is generated by the dokuwki container automatically
 * do not edit it manually
 */
EOF
# Check the value of $LDAP_DOMAIN
if [[ "$LDAP_DOMAIN" == "" ]]; then
    cat <<EOF >> dokuwiki-config/local.protected.php
\$conf['authtype'] = 'authplain';
EOF

elif [[ "$LDAP_DOMAIN" != "" ]]; then
    if [[ "$LDAP_SCHEMA" == "rfc2307" ]]; then
        cat <<EOF >> dokuwiki-config/local.protected.php
\$conf['authtype'] = 'authldap';
\$conf['plugin'][\$conf['authtype']]['server'] = "ldap://accountprovider:${LDAP_PORT}";
\$conf['plugin'][\$conf['authtype']]['version'] = '3';
\$conf['plugin'][\$conf['authtype']]['usertree'] = "ou=People,${LDAP_BASE}";
\$conf['plugin'][\$conf['authtype']]['grouptree'] = "ou=Groups,${LDAP_BASE}";
\$conf['plugin'][\$conf['authtype']]['userfilter'] = '(|(uid=%{user})(mail=%{user}))';
\$conf['plugin']['authldap']['groupfilter']  = '(memberUid=%{uid})';
\$conf['plugin'][\$conf['authtype']]['groupkey'] = 'cn';
\$conf['plugin']['authldap']['binddn']     = "${LDAP_USER}";
\$conf['plugin']['authldap']['bindpw']     = "${LDAP_PASS}";
\$conf['plugin']['authldap']['starttls']   = 0;
\$conf['plugin']['authldap']['modPass'] = 0;
EOF
    elif [[ "$LDAP_SCHEMA" == "ad" ]]; then
        cat <<EOF >> dokuwiki-config/local.protected.php
\$conf['authtype'] = 'authad';
\$conf['plugin']['authad']['account_suffix']     = '@${LDAP_DOMAIN}';
\$conf['plugin']['authad']['base_dn']            = '${LDAP_BASE}';
\$conf['plugin']['authad']['domain_controllers'] = 'ldap://accountprovider:${LDAP_PORT}'; //multiple can be given
\$conf['plugin']['authad']['use_tls'] = 0;
EOF

    fi
fi
cat <<EOF >> dokuwiki-config/local.protected.php
\$conf['useacl'] = 1;
\$conf['superuser'] = 'admin,admin@${LDAP_DOMAIN},administrator,administrator@${LDAP_DOMAIN}';
EOF

echo "Configuration written to dokuwiki-config/local.protected.php"

cat <<EOF > dokuwiki-config/plugins.local.php
<?php
/*
 * Local plugin enable/disable settings
 *
 * Auto-generated by install s
 */

\$plugins['authad']    = 0;
\$plugins['authldap']  = 1;
\$plugins['authad']  = 1;
\$plugins['authmysql'] = 0;
\$plugins['authpgsql'] = 0;
EOF
echo "Configuration written to dokuwiki-config/plugins.local.php"
